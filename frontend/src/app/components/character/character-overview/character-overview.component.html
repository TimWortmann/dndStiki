<ng-template #actionsTemplate let-column="column" let-element="element">
  <div class="vertical-flex">
    <button mat-icon-button (click)="openItemDetailDialog(element)">
      <mat-icon>info_outline</mat-icon>
    </button>

  </div>
</ng-template>

<div class="main-page-button">
  <button mat-raised-button color="primary" [routerLink]="['/']"> Main Page </button>
</div>

<div class="container" *ngIf="characterValue">
  <div class="vertical-flex">
    <ng-container *ngIf="!characterNameChangeActive">
      <h1> {{characterValue.name}} </h1>
      <button mat-icon-button color="primary" (click)="changeNameState()">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button color="primary" (click)="openDownloadsDialog()">
        <mat-icon>download</mat-icon>
      </button>
    </ng-container>

    <ng-container *ngIf="characterNameChangeActive">
      <mat-form-field appearance="outline">
        <mat-label>Character Name</mat-label>
        <input matInput placeholder="Enter your character's name" [(ngModel)]="characterValue.name" (keydown.enter)="changeNameState()">
        <button mat-icon-button matSuffix color="primary" 
        (click)="changeNameState(); $event.stopPropagation(); $event.preventDefault();">
          <mat-icon>save</mat-icon>
        </button>
      </mat-form-field>
    </ng-container>   
  </div>

  <div class="vertical-flex">
    <button mat-icon-button color="primary" (click)="changeLevel(-1)">
      <mat-icon>remove_circle_outline</mat-icon>
    </button>
    <h2> Level {{characterValue.level}}</h2>
    <button mat-icon-button color="primary" (click)="changeLevel(+1)">
      <mat-icon>add_circle_outline</mat-icon>
    </button>
  </div>

  <div class="vertical-flex" style="margin-top: 5px;">
    <div class="vertical-flex">
        <mat-form-field>
          <mat-label>Class</mat-label>
          <mat-select required [(ngModel)]="characterValue.dndClass" [disabled]="!classChangeActive">
            
            <!-- ðŸ” Search field -->
            <mat-option>
              <ngx-mat-select-search
                placeholderLabel="Search classes..."
                noEntriesFoundLabel="No classes found"
                [(ngModel)]="classFilter">
              </ngx-mat-select-search>
            </mat-option>
            
            <ng-container *ngFor="let class of getFilteredClasses()">
              <mat-option [value]="class">
                {{ class }}
              </mat-option>
            </ng-container>

          </mat-select>
        </mat-form-field>
        <button mat-icon-button color="primary" (click)="changeClassState()" *ngIf="!classChangeActive">
            <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="primary" (click)="changeClassState()" *ngIf="classChangeActive">
            <mat-icon>save</mat-icon>
        </button>
    </div>

    <div>
        <div class="vertical-flex">
          <mat-form-field>
            <mat-label>Background</mat-label>
            <mat-select required [(ngModel)]="characterValue.background" [disabled]="!backgroundChangeActive">
              
              <!-- ðŸ” Search field -->
              <mat-option>
                <ngx-mat-select-search
                  placeholderLabel="Search backgrounds..."
                  noEntriesFoundLabel="No backgrounds found"
                  [(ngModel)]="backgroundFilter">
                </ngx-mat-select-search>
              </mat-option>

              <ng-container *ngFor="let background of getFilteredBackgrounds()">
                <mat-option [value]="background">{{ background }}</mat-option>
              </ng-container>

            </mat-select>
          </mat-form-field>
          <button mat-icon-button color="primary" (click)="changeBackgroundState()" *ngIf="!backgroundChangeActive">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="changeBackgroundState()" *ngIf="backgroundChangeActive">
            <mat-icon>save</mat-icon>
          </button>
        </div>
    </div>

    <div>
        <div class="vertical-flex">
          <mat-form-field>
            <mat-label>Race</mat-label>
            <mat-select required [(ngModel)]="characterValue.race" [disabled]="!raceChangeActive">

              <!-- ðŸ” Search field -->
              <mat-option>
                <ngx-mat-select-search
                  placeholderLabel="Search races..."
                  noEntriesFoundLabel="No races found"
                  [(ngModel)]="raceFilter">
                </ngx-mat-select-search>
              </mat-option>

              <ng-container *ngFor="let race of getFilteredRaces()">
                <mat-option [value]="race">{{ race }}</mat-option>
              </ng-container>

            </mat-select>
          </mat-form-field>
          <button mat-icon-button color="primary" (click)="changeRaceState()" *ngIf="!raceChangeActive">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="changeRaceState()" *ngIf="raceChangeActive">
            <mat-icon>save</mat-icon>
          </button>
        </div>
    </div>
  </div>

  <div class="vertical-flex" *ngIf="characterValue.level >= 3 && !classChangeActive">
    <mat-form-field>
        <mat-label>Subclass</mat-label>
        <mat-select required [(ngModel)]="characterValue.dndSubclass"  (selectionChange)="changeSubclass()">
          <ng-container *ngFor="let subclass of characterValue.dndSubclasses"> 
              <mat-option [value]="subclass"> {{subclass}} </mat-option>
          </ng-container>
        </mat-select>
    </mat-form-field>
  </div>

  <div>
    <h2> Basic Information </h2>
    <div class="panel-container">
      <div class="panel">
         <div class="vertical-flex">
            <button mat-icon-button color="primary" matTooltip="Discard" (click)="discardHealthChange()" *ngIf="isHealthChangeActive()">
              <mat-icon>undo</mat-icon>
            </button>
            <h3>Health</h3>
            <button mat-icon-button color="primary" matTooltip="Save" (click)="saveHealthChange()" *ngIf="isHealthChangeActive()">
              <mat-icon>save</mat-icon>
            </button>
         </div>
        <div class="vertical-flex">
          <button mat-icon-button color="primary" matTooltip="Change Current Health" (click)="activateCurrentHealthChange()" *ngIf="!isHealthChangeActive()">
            <mat-icon>edit</mat-icon>
          </button>
          <div class="edit-buttons">
            <button mat-flat-button color="primary" (click)="changeHealth(-10)" *ngIf="isHealthChangeActive()"> - 10 </button>
            <button mat-flat-button color="primary" (click)="changeHealth(-1)" *ngIf="isHealthChangeActive()"> - 1 </button>
          </div>
          <div class="vertical-flex">
            <p [class.changing]="currentHealthChangeActive">{{characterValue.currentHealth}}</p>
            <p>/</p>
            <p [class.changing]="maxHealthChangeActive">{{characterValue.maxHealth}}</p>
          </div>
          <div class="edit-buttons">
            <button mat-flat-button color="primary" (click)="changeHealth(+1)" *ngIf="isHealthChangeActive()"> + 1 </button>
            <button mat-flat-button color="primary" (click)="changeHealth(+10)" *ngIf="isHealthChangeActive()"> + 10 </button>
          </div>
          <button mat-icon-button color="primary" matTooltip="Edit Health Maximum " (click)="activateMaxHealthChange()" *ngIf="!isHealthChangeActive()">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
        <mat-progress-bar mode="determinate"  class="health-progress" [value]="getProcentualHealth()"></mat-progress-bar>
      </div>

      <div class="panel">
        <div class="vertical-flex">
            <button mat-icon-button color="primary" matTooltip="Discard" (click)="discardHitDiceChange()" *ngIf="isHitDiceChangeActive()">
              <mat-icon>undo</mat-icon>
            </button>
            <h3>Hit Dice (d{{characterValue.hitDice}})</h3>
            <button mat-icon-button color="primary" matTooltip="Save" (click)="saveHitDiceChange()" *ngIf="isHitDiceChangeActive()">
              <mat-icon>save</mat-icon>
            </button>
         </div>
        <div class="vertical-flex">
          <button mat-icon-button color="primary" matTooltip="Change Current Hit Dice" (click)="activateCurrentHitDiceChange()" *ngIf="!isHitDiceChangeActive()">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="changeHitDice(-1)" *ngIf="isHitDiceChangeActive()">
            <mat-icon>remove_circle_outline</mat-icon>
          </button>
          <div class="vertical-flex">
            <p [class.changing]="currentHitDiceChangeActive">{{characterValue.currentHitDice}}</p>
            <p>/</p>
            <div class="flex-without-gap">
              <p [class.changing]="maxHitDiceChangeActive">{{characterValue.maxHitDice}}</p>
            </div>
          </div>
          <button mat-icon-button color="primary" (click)="changeHitDice(+1)" *ngIf="isHitDiceChangeActive()">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
          <button mat-icon-button color="primary" matTooltip="Edit Hit Dice Maximum" (click)="activateMaxHitDiceChange()" *ngIf="!isHitDiceChangeActive()">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
        <mat-progress-bar mode="determinate" [value]="getProcentualHitDice()"></mat-progress-bar>
      </div>

      <div class="panel">
        <h3> Armor Class </h3>
        <div class="flex-without-gap">
          <p> {{characterValue.realArmorClass}} </p>
          <button mat-icon-button matTooltip="Edit" (click)="openArmorClassDialog()" *ngIf="!characterValue.armorClassIsModified">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Reset" (click)="resetArmorClass()" *ngIf="characterValue.armorClassIsModified">
            <mat-icon>autorenew</mat-icon>
          </button>
        </div>
        <div class="vertical-flex">
          <p *ngIf="!characterValue.equippedArmor"> Unarmored <b>({{characterValue.basicArmorClass}})</b> </p>
          <p *ngIf="characterValue.equippedArmor"> {{characterValue.equippedArmor.name}} <b>({{characterValue.equippedArmor.ac}}) </b> </p>
          <p *ngIf="characterValue.equippedShield"> | </p>
          <p *ngIf="characterValue.equippedShield">{{characterValue.equippedShield.name}} <b>(+{{characterValue.equippedShield.ac}})</b> </p>
        </div>
      </div>

      <div class="panel">
        <h3> Speed </h3>
        <p> {{characterValue.speed}} feet </p>
      </div>

      <div class="panel">
        <h3> Passive Perception </h3>
        <p> {{characterValue.passivePerception}} </p>
      </div>

      <div class="panel">
        <h3> Proficiency Bonus </h3>
        <p> +{{characterValue.proficiencyBonus}} </p>
      </div>

      <div class="panel" *ngIf="characterValue.spellcastingAbility && characterValue.spellcastingAbility !== ''">
        <h3> Spellcasting Ability </h3>
        <p> {{characterValue.spellcastingAbility}} </p>
      </div>
    </div>
  </div>

  <div class="subsection">
      <h2>Checks</h2>
      <mat-tab-group>
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="vertical-flex">
              <span>Abilities</span>
              <button mat-icon-button matTooltip="Edit Ability Scores" (click)="openPointBuyDialog()">
                <mat-icon>edit</mat-icon>
              </button>
            </div>
          </ng-template>
          <div class="panel-container">
            <div class="panel" *ngFor="let ability of characterValue.abilities">
              <h3> {{ability.name}} </h3>
              <p> {{getModifier(ability)}} </p>
              <p>Score: <b>{{ability.basicScore + ability.bonus}}</b></p>
            </div> 
          </div>
        </mat-tab>
        <mat-tab label="Saving Throws"> 
          <div class="panel-container">
            <div class="panel" *ngFor="let ability of characterValue.abilities">
              <h3> {{ability.name}} </h3>
               <div class="vertical-flex">
                 <p> {{getSavingThrowModifier(ability)}} </p>
                 <mat-icon matTooltip="Proficient" aria-label="Info" *ngIf="ability.savingThrowProficiency == 1">check</mat-icon>
                 <mat-icon matTooltip="Expertise" aria-label="Info" *ngIf="ability.savingThrowProficiency == 2">done_all</mat-icon>
               </div>
            </div> 
          </div>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="vertical-flex">
              <span>Skills</span>
              <button mat-icon-button matTooltip="Edit Skill Proficiencies" (click)="changeSkillEditorState()" *ngIf="!skillChangeActive">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Save Skill Proficiencies" (click)="changeSkillEditorState()" *ngIf="skillChangeActive">
                <mat-icon>save</mat-icon>
              </button>
            </div>
          </ng-template>
          
          <div class="panel-container">
            <div class="panel" *ngFor="let skill of characterValue.skills">
              <div class="vertical-flex">
                <button mat-icon-button color="primary" (click)="removeProficiency(skill)" *ngIf="skillChangeActive">
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
                <h3> {{skill.name}} </h3>
                <button mat-icon-button color="primary" (click)="addProficiency(skill)" *ngIf="skillChangeActive">
                  <mat-icon>add_circle_outline</mat-icon>
                </button>
              </div>
              <p>({{skill.ability}})</p>
             <div class="vertical-flex">
               <p> {{getSkillModifier(skill)}} </p>
               <mat-icon matTooltip="Proficient" aria-label="Info" *ngIf="skill.proficiency == 1">check</mat-icon>
               <mat-icon matTooltip="Expertise" aria-label="Info" *ngIf="skill.proficiency == 2">done_all</mat-icon>
             </div>
            </div> 
          </div>
          <div class="info-box" *ngIf="currentClass || currentBackground">
            <div *ngIf="currentClass">
              <div class="flex">  
                <span><b>Class Proficiencies:</b></span>
                <span> {{getFancyListString((currentClass.skillProficiencies))}}</span>
              </div>
              <p></p>
              <div class="flex">
                <span><b>Number of Class Proficiencies:</b></span>
                <span> {{currentClass.numberOfSkillProficiencies}} </span>
              </div>
            </div>
            <hr class="divider" *ngIf="currentClass && currentBackground">
            <div class="flex" *ngIf="currentBackground">
                <span><b>Background Proficiencies:</b></span>
                <span> {{getFancyListString((currentBackground.proficiencies))}} </span>
            </div>
          </div> 
        </mat-tab>
      </mat-tab-group>
  </div>

  <div class="subsection">
    <h2>Attacks & Spells</h2>
    <mat-tab-group>
        <mat-tab label="Attacks">
          <div class="info-box flex" *ngIf="characterValue.weaponProficiencies">
            <span><b>Class Proficiencies:</b></span>
            <span> {{getFancyListString((characterValue.weaponProficiencies))}}</span>
            <div *ngIf="characterValue.attacks && characterValue.attacks.length > 3">
              <hr class="divider" >
              <span style="color: red;">Only the first three attacks will be visible in the PDF character sheet.</span>  
            </div>
            <div *ngIf="hasModifiedAttacks()">
              <hr class="divider">
              <span style="color: red;">Modified attacks do not update with ability modifier or proficiency bonus changes.</span> 
            </div>
          </div>  

          <p></p>

          <div class="vertical-flex" style="width: 99%;" *ngFor="let attack of characterValue.attacks">
            <mat-form-field appearance="outline" style="width: 100%;">
              <mat-label>Name</mat-label>
              <input matInput [(ngModel)]="attack.name" disabled="true">
            </mat-form-field>

            <mat-form-field appearance="outline" style="width: 100%;">
              <mat-label>Hit Bonus</mat-label>
              <input matInput [(ngModel)]="attack.hitBonus" [disabled]="!isThisAttackCurrentlyEdited(attack)">
            </mat-form-field>

            <mat-form-field appearance="outline" style="width: 100%;">
              <mat-label>Damage Roll</mat-label>
              <input matInput [(ngModel)]="attack.damageRoll" [disabled]="!isThisAttackCurrentlyEdited(attack)">
            </mat-form-field>

            <div class="flex-without-gap">
              <button mat-icon-button matTooltip="Edit" *ngIf="!isThisAttackCurrentlyEdited(attack)"
              [disabled]="isAttackEditDisabled()" (click)="editAttack(attack)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Save" *ngIf="isThisAttackCurrentlyEdited(attack)" (click)="saveAttack(attack)">
                <mat-icon>save</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Remove" (click)="removeAttack(attack.name)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-tab>
        <mat-tab label="Spells"> 
          
        </mat-tab>
      </mat-tab-group>
  </div>

  <div class="subsection">
    <div class="vertical-flex">
      <h2>Inventory</h2>
      <button mat-icon-button (click)="addItem()">
        <mat-icon>add_circle_outline</mat-icon>
      </button>
    </div>
    <mat-tab-group>
      <mat-tab label="Items">
        <div *ngIf="characterValue" class="item-list">
          <app-item-list [data]="characterValue.items" [typeColumn]="true" [bigQuantityColumn]="true" 
          (changeItemQuantityEvent)="changeItemQuantity($event)"></app-item-list>
        </div>
      </mat-tab>
      <mat-tab label="Equipment">
        <div *ngIf="characterValue" class="item-list">
          <app-item-list 
          [data]="characterValue.equipment" 
          [equippedShield]="characterValue.equippedShield"
          [equippedArmor]="characterValue.equippedArmor"
          [equippedWeapons]="characterValue.attacks"
          [bigQuantityColumn]="true" 
          [equippedColumn]="true" [typeColumn]="true" 
          [propertiesColumn]="true" 
          (changeItemQuantityEvent)="changeItemQuantity($event)"
          (equipItemEvent)="equipItem($event)"
          (unequipItemEvent)="unequipItem($event)"></app-item-list>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <div class="subsection">
      <h2>Features & Traits</h2>
      <mat-tab-group>
        <mat-tab label="Class Features">
          <p></p>
          <mat-accordion>
            <ng-container *ngFor="let feature of characterValue.classFeatures">
              <ng-container>
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title> {{feature.name}} </mat-panel-title>
                  </mat-expansion-panel-header>
                    <div class="trait-text">{{feature.text}}</div>
                </mat-expansion-panel>
              </ng-container>
            </ng-container>
          </mat-accordion> 
        </mat-tab>

        <mat-tab label="Background Traits">
          <p></p>
          <mat-accordion>
            <ng-container *ngFor="let trait of characterValue.backgroundTraits">
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title> {{trait.name}} </mat-panel-title>
                </mat-expansion-panel-header>
                  <div class="trait-text">{{trait.text}}</div>
              </mat-expansion-panel>
            </ng-container>
          </mat-accordion>  
        </mat-tab>

        <mat-tab label="Race Traits"> 
          <p></p>
          <mat-accordion>
            <ng-container *ngFor="let trait of characterValue.raceTraits">
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title> {{trait.name}} </mat-panel-title>
                </mat-expansion-panel-header>
                  <div class="trait-text">{{trait.text}}</div>
              </mat-expansion-panel>
            </ng-container>
          </mat-accordion> 
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="vertical-flex">
              <span>Feats</span>
              <button mat-icon-button (click)="openFeatDialog()">
                <mat-icon>add_circle_outline</mat-icon>
              </button>
            </div>
          </ng-template>
          <p></p>
          <mat-accordion>
            <ng-container *ngFor="let feat of characterValue.feats">
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title> {{feat.name}} </mat-panel-title>
                </mat-expansion-panel-header>
                  <div class="trait-text">{{feat.text}}</div>
                  <button mat-icon-button (click)="removeFeat(feat)" class="bottom-right">
                    <mat-icon>delete</mat-icon>
                  </button>
              </mat-expansion-panel>
            </ng-container>
          </mat-accordion>  
        </mat-tab>
      </mat-tab-group>
  </div>
</div>
